From b4c643f9b2c5ab11bd793b154b2f874ec38886a0 Mon Sep 17 00:00:00 2001
From: Daniel Sangorrin <daniel.sangorrin@gmail.com>
Date: Fri, 24 Jun 2011 17:00:11 +0900
Subject: [PATCH 1/2] fix for non-trust (TODO: change env address)

---
 board/samsung/mini6410/config.mk       |    2 +-
 board/samsung/mini6410/lowlevel_init.S |    2 +-
 cpu/s3c64xx/config.mk                  |    4 +++-
 cpu/s3c64xx/cpu.c                      |   19 ++++++++++++++++---
 cpu/s3c64xx/s3c6410/speed.c            |    1 +
 cpu/s3c64xx/start.S                    |   32 ++++++++++----------------------
 include/configs/mini6410.h             |   17 +++++++++--------
 7 files changed, 41 insertions(+), 36 deletions(-)

diff --git a/board/samsung/mini6410/config.mk b/board/samsung/mini6410/config.mk
index f6d3847..133b1b0 100644
--- a/board/samsung/mini6410/config.mk
+++ b/board/samsung/mini6410/config.mk
@@ -25,6 +25,6 @@
 
 
 ifndef TEXT_BASE
-TEXT_BASE = 0xc7e00000
+TEXT_BASE = 0x57C00000
 endif
 
diff --git a/board/samsung/mini6410/lowlevel_init.S b/board/samsung/mini6410/lowlevel_init.S
index ddd5538..b889a99 100644
--- a/board/samsung/mini6410/lowlevel_init.S
+++ b/board/samsung/mini6410/lowlevel_init.S
@@ -108,7 +108,7 @@ lowlevel_init:
 	bl nand_asm_init
 #endif
 
-#if 0
+#if 1
 	ldr	r0, =0xff000fff
 	bic	r1, pc, r0		/* r0 <- current base addr of code */
 	ldr	r2, _TEXT_BASE		/* r1 <- original base addr in ram */
diff --git a/cpu/s3c64xx/config.mk b/cpu/s3c64xx/config.mk
index 204e880..3846393 100644
--- a/cpu/s3c64xx/config.mk
+++ b/cpu/s3c64xx/config.mk
@@ -24,7 +24,9 @@ PLATFORM_RELFLAGS += -fno-strict-aliasing  -fno-common -ffixed-r8 \
 	-msoft-float
 
 # Make ARMv5 to allow more compilers to work, even though its v6.
-PLATFORM_CPPFLAGS += -march=armv5t
+# PLATFORM_CPPFLAGS += -march=armv5t
+PLATFORM_CPPFLAGS += -mcpu=arm1176jz-s -mlittle-endian -msoft-float
+
 # =========================================================================
 #
 # Supply options according to compiler version
diff --git a/cpu/s3c64xx/cpu.c b/cpu/s3c64xx/cpu.c
index 96a064f..a8494fb 100644
--- a/cpu/s3c64xx/cpu.c
+++ b/cpu/s3c64xx/cpu.c
@@ -126,9 +126,22 @@ int cleanup_before_linux (void)
 	asm ("mcr p15, 0, %0, c1, c0, 0": :"r" (i));
 
 	/* flush I/D-cache */
-	i = 0;
-	asm ("mcr p15, 0, %0, c7, c7, 0": :"r" (i));  /* invalidate both caches and flush btb */
-	asm ("mcr p15, 0, %0, c7, c10, 4": :"r" (i)); /* mem barrier to sync things */
+// 	i = 0;
+// 	asm ("mcr p15, 0, %0, c7, c7, 0": :"r" (i));  /* invalidate both caches and flush btb */
+// 	asm ("mcr p15, 0, %0, c7, c10, 4": :"r" (i)); /* mem barrier to sync things */
+
+#define Asm		asm volatile
+#define CP15_ICACHE_INVALIDATE() Asm("mcr p15, 0, %0, c7, c5, 0"::"r"(0))
+#define CP15_DCACHE_CLEAN_AND_INVALIDATE() \
+	Asm("mcr p15, 0, %0, c7, c14, 0":: "r"(0))
+#define CP15_DATA_MEMORY_BARRIER() Asm("mcr p15, 0, %0, c7, c10, 5"::"r" (0));
+#define CP15_DATA_SYNC_BARRIER() Asm("mcr p15, 0, %0, c7, c10, 4"::"r"(0))
+
+	CP15_ICACHE_INVALIDATE();
+	CP15_DCACHE_CLEAN_AND_INVALIDATE();
+	CP15_DATA_MEMORY_BARRIER();
+	CP15_DATA_SYNC_BARRIER();
+
 	return(0);
 }
 
diff --git a/cpu/s3c64xx/s3c6410/speed.c b/cpu/s3c64xx/s3c6410/speed.c
index 8202218..88e2202 100644
--- a/cpu/s3c64xx/s3c6410/speed.c
+++ b/cpu/s3c64xx/s3c6410/speed.c
@@ -121,6 +121,7 @@ ulong get_UCLK(void)
 
 int print_cpuinfo(void)
 {
+	printf("\nSafeG MINI6410 Non-Trust u-boot\n");
 	printf("\nCPU:     S3C6410@%dMHz\n", get_ARMCLK()/1000000);
 	printf("         Fclk = %dMHz, Hclk = %dMHz, Pclk = %dMHz",
 			get_FCLK()/1000000, get_HCLK()/1000000, get_PCLK()/1000000);
diff --git a/cpu/s3c64xx/start.S b/cpu/s3c64xx/start.S
index fe3481c..ed7ad62 100644
--- a/cpu/s3c64xx/start.S
+++ b/cpu/s3c64xx/start.S
@@ -133,14 +133,19 @@ FIQ_STACK_START:
  * the actual reset code
  */
 
+#define UINT_C(val)		(val)
+#define CPSR_SVC      UINT_C(0x13)
+#define CPSR_IRQ_BIT  UINT_C(0x80)
+#define CPSR_FIQ_BIT  UINT_C(0x40)
+#define CPSR_INTLOCK  (CPSR_FIQ_BIT|CPSR_IRQ_BIT)
+
+    .code 32
+    .align 2
 reset:
 	/*
 	 * set the cpu to SVC32 mode
 	 */
-	mrs	r0,cpsr
-	bic	r0,r0,#0x1f
-	orr	r0,r0,#0xd3
-	msr	cpsr,r0
+	msr  cpsr, #(CPSR_SVC|CPSR_INTLOCK)
 
 /*
  *************************************************************************
@@ -157,27 +162,10 @@ reset:
          * not when booting from ram!
          */
 cpu_init_crit:
-	/*
-	 * flush v4 I/D caches
-	 */
-	mov	r0, #0
-	mcr	p15, 0, r0, c7, c7, 0	/* flush v3/v4 cache */
-	mcr	p15, 0, r0, c8, c7, 0	/* flush v4 TLB */
-
-	/*
-	 * disable MMU stuff and caches
-	 */
-	mrc	p15, 0, r0, c1, c0, 0
-	bic	r0, r0, #0x00002300	@ clear bits 13, 9:8 (--V- --RS)
-	bic	r0, r0, #0x00000087	@ clear bits 7, 2:0 (B--- -CAM)
-	orr	r0, r0, #0x00000002	@ set bit 2 (A) Align
-	orr	r0, r0, #0x00001000	@ set bit 12 (I) I-Cache
-	mcr	p15, 0, r0, c1, c0, 0
-
 	/* Peri port setup */
 	ldr	r0, =0x70000000
 	orr	r0, r0, #0x13
-    	mcr	p15,0,r0,c15,c2,4       @ 256M(0x70000000-0x7fffffff)
+	mcr	p15,0,r0,c15,c2,4       @ 256M(0x70000000-0x7fffffff)
 
 #ifdef CONFIG_BOOT_ONENAND
 	ldr	r0, =0x70000000		@ onenand controller setup
diff --git a/include/configs/mini6410.h b/include/configs/mini6410.h
index 0ba0ad9..7ae3d29 100644
--- a/include/configs/mini6410.h
+++ b/include/configs/mini6410.h
@@ -100,7 +100,8 @@
 /*
  * select serial console configuration
  */
-#define CONFIG_SERIAL1          1	/* we use SERIAL 1 on SMDK6400 */
+// #define CONFIG_SERIAL1          1	/* we use SERIAL 1 on SMDK6400 */
+#define CONFIG_SERIAL2	1
 
 #define CFG_HUSH_PARSER			/* use "hush" command parser	*/
 #ifdef CFG_HUSH_PARSER
@@ -163,12 +164,12 @@
 #include <cmd_confdefs.h>
 
 #define CONFIG_BOOTDELAY	3
-#define CONFIG_BOOTARGS    	"root=/dev/mtdblock2 console=ttySAC0,115200"
+#define CONFIG_BOOTARGS    	"root=ubi0:FriendlyARM-root ubi.mtd=2 rootfstype=ubifs  init=/linuxrc console=ttySAC0,115200 androidboot.console=s3c2410_serial0"
 #define CONFIG_ETHADDR		08:90:90:90:90:90
 #define CONFIG_NETMASK          255.255.255.0
-#define CONFIG_IPADDR		192.168.1.230
-#define CONFIG_SERVERIP		192.168.1.88
-#define CONFIG_GATEWAYIP	192.168.1.1
+#define CONFIG_IPADDR		192.168.0.33
+#define CONFIG_SERVERIP		192.168.0.34
+#define CONFIG_GATEWAYIP	192.168.0.34
 
 #define CONFIG_ZERO_BOOTDELAY_CHECK
 
@@ -386,11 +387,11 @@
 
 /* base address for uboot */
 #ifdef CONFIG_ENABLE_MMU
-#define CFG_UBOOT_BASE		0xc7e00000
+#define CFG_UBOOT_BASE		0xc7c00000
 #else
-#define CFG_UBOOT_BASE		0x57e00000
+#define CFG_UBOOT_BASE		0x57c00000
 #endif
-#define CFG_PHY_UBOOT_BASE	MEMORY_BASE_ADDRESS + 0x7e00000
+#define CFG_PHY_UBOOT_BASE	MEMORY_BASE_ADDRESS + 0x7c00000
 
 #define CFG_ENV_OFFSET		0x00040000
 
-- 
1.7.0.4


From b4f3bda79e73747158e4628c110660826ebc5bbc Mon Sep 17 00:00:00 2001
From: Daniel Sangorrin <daniel.sangorrin@gmail.com>
Date: Tue, 6 Sep 2011 15:02:26 +0900
Subject: [PATCH 2/2] change environment

---
 include/configs/mini6410.h |    8 ++++----
 1 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/include/configs/mini6410.h b/include/configs/mini6410.h
index 7ae3d29..c54617d 100644
--- a/include/configs/mini6410.h
+++ b/include/configs/mini6410.h
@@ -100,8 +100,8 @@
 /*
  * select serial console configuration
  */
-// #define CONFIG_SERIAL1          1	/* we use SERIAL 1 on SMDK6400 */
-#define CONFIG_SERIAL2	1
+#define CONFIG_SERIAL1          1	/* we use SERIAL 1 on SMDK6400 */
+// #define CONFIG_SERIAL2	1
 
 #define CFG_HUSH_PARSER			/* use "hush" command parser	*/
 #ifdef CFG_HUSH_PARSER
@@ -373,7 +373,7 @@
 #define CFG_FLASH_ERASE_TOUT	(5*CFG_HZ) /* Timeout for Flash Erase */
 #define CFG_FLASH_WRITE_TOUT	(5*CFG_HZ) /* Timeout for Flash Write */
 
-#define CFG_ENV_ADDR		0
+#define CFG_ENV_ADDR		0x60000
 #define CFG_ENV_SIZE		0x20000	/* Total Size of Environment Sector */
 
 /*
@@ -393,7 +393,7 @@
 #endif
 #define CFG_PHY_UBOOT_BASE	MEMORY_BASE_ADDRESS + 0x7c00000
 
-#define CFG_ENV_OFFSET		0x00040000
+#define CFG_ENV_OFFSET		0x000A0000
 
 /* NAND configuration */
 #define CFG_MAX_NAND_DEVICE     1
-- 
1.7.0.4

